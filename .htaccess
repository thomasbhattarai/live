# ============================================================================
# Discover Nepal Travel - Production .htaccess
# Last Updated: January 2026
# ============================================================================

# ---------------------------------------------------------------------------
# DISABLE CLOUDFLARE EMAIL PROTECTION
# ---------------------------------------------------------------------------
<IfModule mod_headers.c>
    Header set X-Forwarded-Email "no-protection"
    Header set CF-Email-Protection "no-protection"
</IfModule>

# ---------------------------------------------------------------------------
# ENABLE REWRITE ENGINE
# ---------------------------------------------------------------------------
RewriteEngine On
RewriteBase /

# ---------------------------------------------------------------------------
# FORCE HTTPS + NON-WWW (CORRECTED FOR SEO)
# ---------------------------------------------------------------------------
RewriteCond %{HTTP_HOST} ^www\. [NC]
RewriteRule ^(.*)$ https://discovernepal.com/$1 [R=301,L]

RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://discovernepal.com/$1 [R=301,L]

# ---------------------------------------------------------------------------
# SECURITY & PROTECTION
# ---------------------------------------------------------------------------

# Protect sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak|sql|gitignore)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Disable directory listing
Options -Indexes
IndexIgnore *

# Protect against XSS & clickjacking
<IfModule mod_headers.c>
    Header set X-XSS-Protection "1; mode=block"
    Header always append X-Frame-Options SAMEORIGIN
    Header set X-Content-Type-Options nosniff
</IfModule>

# Disable server signature
ServerSignature Off

# Limit HTTP methods
<LimitExcept GET POST HEAD>
    Deny from all
</LimitExcept>

# ---------------------------------------------------------------------------
# PERFORMANCE OPTIMIZATION
# ---------------------------------------------------------------------------

# Enable GZIP compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/css text/javascript application/javascript application/x-javascript application/json application/xml application/rss+xml
    AddOutputFilterByType DEFLATE application/font-woff application/font-woff2 application/vnd.ms-fontobject application/x-font-ttf application/x-font-opentype font/opentype image/svg+xml
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
</IfModule>

# Browser caching
<IfModule mod_expires.c>
    ExpiresActive On

    # Images
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"

    # CSS & JS
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"

    # Others
    ExpiresByType application/pdf "access plus 1 month"
</IfModule>

# MIME Types & Encoding
AddType application/javascript .js
AddType text/css .css
AddType image/svg+xml .svg .svgz
AddEncoding x-gzip .svgz
AddType application/vnd.ms-fontobject .eot
AddType application/x-font-ttf .ttf .ttc
AddType font/opentype .otf
AddType application/x-font-woff .woff
AddType image/x-icon .ico
AddType image/webp .webp
AddDefaultCharset UTF-8
<IfModule mod_mime.c>
    AddCharset UTF-8 .html .css .js .xml .json .rss .atom
</IfModule>

# ---------------------------------------------------------------------------
# SEO-FRIENDLY URLS
# ---------------------------------------------------------------------------

# Remove .html extension
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.html -f
RewriteRule ^(.*)$ $1.html [NC,L]

# Remove .php extension (if PHP is added later)
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php -f
RewriteRule ^(.*)$ $1.php [NC,L]

# Canonical redirects (index variations)
RewriteRule ^index\.(php|html)$ / [R=301,L]
RewriteRule ^(.*)/index\.(php|html)$ /$1/ [R=301,L]

# Redirect old / common typo URLs
RedirectMatch 301 (?i)^/trekking$ /trekking-in-nepal.html
RedirectMatch 301 (?i)^/tours$ /tours-in-nepal.html
RedirectMatch 301 (?i)^/packages$ /travel-packages.html
RedirectMatch 301 (?i)^/guide$ /travel-guide.html
RedirectMatch 301 (?i)^/about$ /about-us.html
RedirectMatch 301 (?i)^/contact-us$ /contact.html

# Redirect old blog URLs
RewriteRule ^blog/tips/(.*)$ /blog/$1.html [R=301,L]

# Redirect old trekking / tour URLs
RewriteRule ^treks/(.*)$ /trekking-in-nepal.html#$1 [R=301,L,NE]
RewriteRule ^tours/(.*)$ /tours-in-nepal.html#$1 [R=301,L,NE]

# ---------------------------------------------------------------------------
# CUSTOM ERROR PAGES
# ---------------------------------------------------------------------------
ErrorDocument 400 /404.html
ErrorDocument 401 /404.html
ErrorDocument 403 /403.html
ErrorDocument 404 /404.html
ErrorDocument 500 /500.html

# ---------------------------------------------------------------------------
# HOTLINKING PROTECTION
# ---------------------------------------------------------------------------
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^http(s)?://(www\.)?discovernepal\.com [NC]
RewriteRule \.(jpg|jpeg|png|gif|webp)$ - [NC,F,L]

# ---------------------------------------------------------------------------
# BLOCK BAD BOTS & SQL INJECTION
# ---------------------------------------------------------------------------

# Block common bots
RewriteCond %{HTTP_USER_AGENT} ^.*(AhrefsBot|DotBot|MJ12bot|SemrushBot|spbot).*$ [NC]
RewriteRule .* - [F,L]

# Block basic SQL injection attempts
RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2})
RewriteRule ^(.*)$ - [F,L]

# ---------------------------------------------------------------------------
# MAINTENANCE MODE (Uncomment when needed)
# ---------------------------------------------------------------------------
# RewriteCond %{REMOTE_ADDR} !^123\.456\.789\.000
# RewriteCond %{REQUEST_URI} !/maintenance\.html$
# RewriteRule ^(.*)$ /maintenance.html [R=302,L]

# ============================================================================
# END OF .htaccess
# ============================================================================
